<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<link href="css/style.css" rel="stylesheet">
		<link href="css/sweetalert.css" rel="stylesheet" type="text/css" >
		<script src="lib/jquery-1.11.2.min.js"></script>
		<script src="lib/sweetalert.min.js"></script> 
		<title>Web game pad demo</title>
	</head>
	<body>
		<div id="textDiv">
			Welcome to Gamepad.
		</div>
		<br>
		<br>
		<div id="mainDiv">
			<div id="gamePadDiv">				
				<img class="imgDiv" src="images/xbox_360_controller.png">				
				<div id="highlightButtonBallDiv"></div>
				<div id="highlightAxisBallDiv"></div>
			</div>
		</div>
		<script type="text/javascript">

			var rAF = window.requestAnimationFrame ||
			  window.mozRequestAnimationFrame ||
			  window.webkitRequestAnimationFrame;

			var rAFStop = window.cancelRequestAnimationFrame ||
			  window.mozCancelRequestAnimationFrame ||
			  window.webkitCancelRequestAnimationFrame;

			var start;
			var mainGamePadIndex = -1;

			window.addEventListener("gamepadconnected", function(e) {

				swal({   title: "Game pad connected!",   text: "I will close in 3 seconds.",  
					type: "success", timer: 3000,   showConfirmButton: false });

			  	console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
			    e.gamepad.index, e.gamepad.id,
			    e.gamepad.buttons.length, e.gamepad.axes.length);

			  	if ( e.gamepad.index == 0 )
			  		mainGamePadIndex = e.gamepad.index;

			  	if ( e.gamepad.index > 0 )
			  		alert("We just support one gamepad currently.");

			  var div = document.getElementById("textDiv");
    			div.textContent += "Game pad connected";

    			gameLoop();

			});

			window.addEventListener("gamepaddisconnected", function(e) {

				swal({   title: "Game pad disconnected!",   text: "I will close in 3 seconds.",  
					type: "warning", timer: 3000,   showConfirmButton: false });

			  console.log("Gamepad disconnected from index %d: %s",
			    e.gamepad.index, e.gamepad.id);
			  var div = document.getElementById("textDiv");
    			div.textContent += "Game pad disconnected";

    			 rAFStop(start);
			});

			var buttonPos = [
				{'x': '22%', 'y': '28%'},
				{'x': '22%', 'y': '50%'},
				{'x': '18%', 'y': '39%'},
				{'x': '26%', 'y': '39%'},
				{'x': '40%', 'y': '20%'},
				{'x': '25%', 'y': '20%'},
				{'x': '12%', 'y': '17%'},
				{'x': '42%', 'y': '39%'},
				{'x': '12%', 'y': '-2%'},
				{'x': '52%', 'y': '-2%'},
				{'x': '33%', 'y': '18%'},
				{'x': '52%', 'y': '28%'},
				{'x': '57%', 'y': '18%'},
				{'x': '47%', 'y': '18%'},
				{'x': '52%', 'y': '8%'}
			];

			var axisPos = [
				{'x': '17%', 'y': '16%'},
				{'x': '9%', 'y': '16%'},
				{'x': '13%', 'y': '25%'},
				{'x': '13%', 'y': '8%'},
				{'x': '13%', 'y': '-2%'},
				{'x': '13%', 'y': '-2%'}, 
				{'x': '45%', 'y': '39%'}, 
				{'x': '40%', 'y': '39%'},
				{'x': '43%', 'y': '44%'},
				{'x': '43%', 'y': '34%'},
				{'x': '52%', 'y': '-2%'},
				{'x': '52%', 'y': '-2%'},
			];

			function buttonPressed(btn, index) {

				if (typeof(btn) == "object") {

					if (btn.pressed || btn.value) {

						console.log("You press buttion " + index);
						var btnBallElement = $('#highlightButtonBallDiv')[0];	
						var pos = buttonPos[index];
						btnBallElement.style.left = pos.x;
						btnBallElement.style.top = pos.y;
						btnBallElement.style.display = 'block';
					}
					
				}
			}

			function axisPressed(axis, posIndex, negIndex) {
				 
			 	var axisBallElement = $('#highlightAxisBallDiv')[0];	
 
			 	if (axis == 1) {

					console.log("You press axis " + posIndex);
					var pos = axisPos[posIndex];
					axisBallElement.style.left = pos.x;
					axisBallElement.style.top = pos.y;
					axisBallElement.style.display = 'block';

			    } else if (axis == -1) {

			    	if(negIndex == 5 || negIndex == 11)
			    		return;

					console.log("You press axis " + negIndex);
					var pos = axisPos[negIndex];
					axisBallElement.style.left = pos.x;
					axisBallElement.style.top = pos.y;
					axisBallElement.style.display = 'block';
			    }
			}

			function gameLoop() {

				var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads : []);
				
				if (!gamepads) {
				    return;
				}

				// Disable highlight
				var btnBallElement = $('#highlightButtonBallDiv')[0];
				btnBallElement.style.display = 'none';

				var axisBallElement = $('#highlightAxisBallDiv')[0];
				axisBallElement.style.display = 'none';
				// end of disable

				var gp = gamepads[0];

				for (var i = 0; i < gp.buttons.length; ++i) {

					buttonPressed(gp.buttons[i], i);
				}

				for (var i = 0; i < gp.axes.length; ++i) {

					axisPressed(gp.axes[i], i*2, (i*2)+1);
				}

				start = rAF(gameLoop);
			}

		</script>	
	</body>
</html>