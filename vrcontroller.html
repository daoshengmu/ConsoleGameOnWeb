<!DOCTYPE html>

<!--
Web Gamepad API experiment of VR controller
author: daoshengmu, http://dsmu.me
date: 10/08/2016
-->

<html lang="en">
	<head>
		<meta charset="utf-8">
		<link href="css/style.css" rel="stylesheet">
		<style>
			body {
				background-color: #ffffff;
			}
		</style>
		<script src="lib/jquery-1.11.2.min.js"></script>
		<title>Web VRController Demo</title>
	</head>
	<body>
    <h1>Welcome to VR controller test page.</h1>
    <h1 id="gamepadCount"></h1>
		<div id="textDiv">
		<!-- 	<h2 id="gamepadTxt">Welcome to Web VR controller Demo.<h2>
        <h2 id="gamepadTxt">Welcome to Web VR controller Demo1.<h2>
          <h2 id="gamepadTxt">Welcome to Web VR controller Demo2.<h2> -->
		</div>
   <!--  <div id="textDiv">
      <h2 id="gamepad1ButtonTxt">Welcome to Web VR controller Demo.<h2>
    </div>
    <div id="textDiv">
      <h2 id="gamepad2ButtonTxt">Welcome to Web VR controller Demo.<h2>
    </div>
    <div id="textDiv">
      <h2 id="gamepad1AxisTxt">Welcome to Web VR controller Demo.<h2>
    </div>
    <div id="textDiv">
      <h2 id="gamepad2AxisTxt">Welcome to Web VR controller Demo.<h2>
    </div>
    <div id="textDiv">
      <h2 id="gamepad1PoseTxt">Welcome to Web VR controller Demo.<h2>
    </div>
    <div id="textDiv">
      <h2 id="gamepad2PoseTxt">Welcome to Web VR controller Demo.<h2>
    </div> -->
		<div id="mainDiv">
		  <div id="vrControllerDiv">	
        <canvas id="webgl-canvas"></canvas>
				<!-- <img class="imgDiv" src="images/xbox_360_controller.png">				
				<div id="highlightButtonBallDiv"></div>
				<div id="highlightAxisBallDiv"></div> -->
			</div>
		</div>
		<script type="text/javascript">

			var rAF = window.requestAnimationFrame ||
			  window.mozRequestAnimationFrame ||
			  window.webkitRequestAnimationFrame;

			var rAFStop = window.cancelRequestAnimationFrame ||
			  window.mozCancelRequestAnimationFrame ||
			  window.webkitCancelRequestAnimationFrame;

			var start;
			var mainGamePadIndex = -1;
			var OSType;
      var gl = null;
      var vrDisplay = null;
      var numGamepads = 0;
      var timeThreshold = 5000;
      var lastTime = 0;

      function init() {

        if (navigator.getVRDisplays) {
          navigator.getVRDisplays().then(function (displays) {
            if (displays.length > 0) {
              vrDisplay = displays[0];
              vrDisplay.depthNear = 0.1;
              vrDisplay.depthFar = 1024.0;
              initWebGL(true);
              if (vrDisplay.stageParameters &&
                  vrDisplay.stageParameters.sizeX > 0 &&
                  vrDisplay.stageParameters.sizeZ > 0) {
                // cubeIsland.resize(vrDisplay.stageParameters.sizeX, vrDisplay.stageParameters.sizeZ);
              }
              // VRSamplesUtil.addButton("Reset Pose", "R", null, function () { vrDisplay.resetPose(); });
              // if (vrDisplay.capabilities.canPresent)
              //   // vrPresentButton = VRSamplesUtil.addButton("Enter VR", "E", "media/icons/cardboard64.png", onVRRequestPresent);
              // window.addEventListener('vrdisplaypresentchange', onVRPresentChange, false);
              // window.addEventListener('vrdisplayactivate', onVRRequestPresent, false);
              // window.addEventListener('vrdisplaydeactivate', onVRExitPresent, false);
            } else {
              initWebGL(false);
              //VRSamplesUtil.addInfo("WebVR supported, but no VRDisplays found.", 3000);
            }
          });
        } else if (navigator.getVRDevices) {
          initWebGL(false);
          // VRSamplesUtil.addError("Your browser supports WebVR but not the latest version. See <a href='http://webvr.info'>webvr.info</a> for more info.");
        } else {
          initWebGL(false);
          // VRSamplesUtil.addError("Your browser does not support WebVR. See <a href='http://webvr.info'>webvr.info</a> for assistance.");
        }
      }

      function initWebGL(preserveDrawingBuffer) {
        var webglCanvas = document.getElementById("webgl-canvas");

        var glAttribs = {
          antialias: false,
          preserveDrawingBuffer: preserveDrawingBuffer
        };

        gl = webglCanvas.getContext("webgl", glAttribs);
        gl.clearColor(1.0, 1.0, 1.0, 1.0);

        animate();
      }

      function onWindowResize() {

      }

      function animate() {
        requestAnimationFrame(animate);

        if ( numGamepads != navigator.getGamepads().length) {
          var countElement = document.getElementById('gamepadCount');          
          countElement.textContent = 'You have ' + navigator.getGamepads().length +
                                     ' gamepads.';
          numGamepads = navigator.getGamepads().length;

          for (var i = 0; i <= numGamepads; ++i) {
            var gamepad = navigator.getGamepads()[i];
            countElement.textContent += gamepad.hand + ', ';
          }
        }

        var txtElement = document.getElementById('textDiv');
        var currentTime = Date.now();
        if (currentTime - lastTime > timeThreshold) {
          // Remove all existing elements
          while (txtElement.firstChild) {
            txtElement.removeChild(txtElement.firstChild);
          }

          lastTime = currentTime;
        }

        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        if (vrDisplay) {
          var vrGamepads = [];
          var gamepads = navigator.getGamepads();

          for (var i = 0; i < gamepads.length; ++i) {
            var gp = gamepads[i];

            if (!gp)
              continue;

            // for ( var j = 0; j < gp.buttons.length; ++j ) {
            //   buttonPressed(i, gp.buttons[j], j);
            // }

            // for ( var j = 0; j < gp.axes.length; ++j ) {
            //   axisPressed(i, gp.axes[j], j);
            // }

            poseState(i, gp.pose);

          }
        }
      }

      var count = 0;
      function testGamepad() {
        var div = $('#gamepad2PoseTxt')[0];
        count++;
        div.textContent = count;       
      }

			function buttonPressed(gamepadIdx, btn, index) {

				if ( typeof(btn) == "object" ) {
					if ( btn.pressed || btn.value ) {
              var txt = 'receive gamepadIdx ' + gamepadIdx +
                        ' button ' + index +' pressed';

              var txtElement = document.getElementById('textDiv');
              var node = document.createElement('h2');
              node.textContent = txt;

              txtElement.appendChild(node);

              // if (index === 3) {
              //   var gamepads = navigator.getGamepads();
              //   gamepads[gamepadIdx].hapticActuators[0].pulse(btn.value, 5000);
              // }
					}
				}
			}

			function axisPressed(gamepadIdx, axis, index) {
          if (axis != 0) {
            var txt = 'receive gamepadIdx ' + gamepadIdx +
                      ' axis ' + index +' value ' + axis;

            var txtElement = document.getElementById('textDiv');
            var node = document.createElement('h2');
            node.textContent = txt;

            txtElement.appendChild(node);
          }
			}

      function poseState(gamepadIdx, pose) {
        //return;
        if (pose) {
          var txt = 'receive gamepadIdx ' + gamepadIdx +
                    ' position ' + pose.position +
                    ' linearVelocity ' + pose.linearVelocity +
                    ' linearAcceleration ' + pose.linearAcceleration +
                    ' orientation ' + pose.orientation +
                    ' angularVelocity ' + pose.angularVelocity +
                    ' angularAcceleration ' + pose.angularAcceleration;


          var txtElement = document.getElementById('textDiv');
          var node = document.createElement('h2');
          node.textContent = txt;

          txtElement.appendChild(node);
        }
      }

      init();
		</script>	
	</body>
</html>